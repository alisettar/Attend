@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["ScannerPage"];
    var events = ViewBag.Events as List<EventViewModel> ?? new List<EventViewModel>();
    var selectedEventId = ViewBag.SelectedEventId as Guid?;
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h2><i class="bi bi-qr-code-scan me-2"></i>@Localizer["ScannerPage"]</h2>
                <p class="text-muted">@Localizer["ScanQROrEnterManually"]</p>
            </div>

            <!-- Event Selection -->
            <div class="card mb-4">
                <div class="card-body">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-event me-2"></i>@Localizer["SelectEvent"]
                    </label>
                    @if (events.Any())
                    {
                        <select id="eventSelect" class="form-select form-select-lg">
                            <option value="">-- @Localizer["SelectEvent"] --</option>
                            @foreach (var evt in events)
                            {
                                <option value="@evt.Id" selected="@(selectedEventId == evt.Id)">
                                    @evt.Title - @evt.Date.ToString("dd MMM yyyy")
                                </option>
                            }
                        </select>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>@Localizer["NoActiveEvents"]
                        </div>
                    }
                </div>
            </div>

            <!-- Scan Mode Toggle -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="scanMode" id="usbMode" checked>
                        <label class="btn btn-outline-primary" for="usbMode">
                            <i class="bi bi-upc-scan me-1"></i>@Localizer["USBScanner"]
                        </label>
                        <input type="radio" class="btn-check" name="scanMode" id="cameraMode">
                        <label class="btn btn-outline-primary" for="cameraMode">
                            <i class="bi bi-camera me-1"></i>@Localizer["CameraScanner"]
                        </label>
                    </div>
                </div>
            </div>

            <!-- USB Scanner Input -->
            <div class="card mb-4" id="usbSection">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upc-scan me-2"></i>@Localizer["USBScanner"]
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" 
                               id="qrInput" 
                               class="form-control form-control-lg text-center" 
                               placeholder="@Localizer["EnterQRCode"]"
                               autocomplete="off"
                               autofocus />
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        USB tarayıcınız otomatik olarak QR kodunu okuyacaktır
                    </div>
                </div>
            </div>

            <!-- Camera Scanner -->
            <div class="card mb-4 d-none" id="cameraSection">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-camera me-2"></i>@Localizer["CameraScanner"]
                    </h5>
                </div>
                <div class="card-body">
                    <div id="reader" style="width: 100%;"></div>
                    <div class="text-center mt-3">
                        <button id="startCamera" class="btn btn-success">
                            <i class="bi bi-camera-video me-1"></i>@Localizer["StartScanning"]
                        </button>
                        <button id="stopCamera" class="btn btn-danger d-none">
                            <i class="bi bi-camera-video-off me-1"></i>@Localizer["StopScanner"]
                        </button>
                    </div>
                    <div class="text-muted small mt-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Tarayıcınız kamera erişimi isteyecektir. Lütfen izin verin.
                    </div>
                </div>
            </div>

            <!-- Feedback Area -->
            <div id="feedbackArea"></div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    const qrInput = document.getElementById('qrInput');
    const eventSelect = document.getElementById('eventSelect');
    const feedbackArea = document.getElementById('feedbackArea');
    const usbSection = document.getElementById('usbSection');
    const cameraSection = document.getElementById('cameraSection');
    const usbMode = document.getElementById('usbMode');
    const cameraMode = document.getElementById('cameraMode');
    const startCamera = document.getElementById('startCamera');
    const stopCamera = document.getElementById('stopCamera');
    
    let isProcessing = false;
    let html5QrcodeScanner = null;

    // Auto-focus on load
    qrInput.focus();

    // Mode switching
    usbMode.addEventListener('change', function() {
        if (this.checked) {
            usbSection.classList.remove('d-none');
            cameraSection.classList.add('d-none');
            stopCameraScanner();
            setTimeout(() => qrInput.focus(), 100);
        }
    });

    cameraMode.addEventListener('change', function() {
        if (this.checked) {
            usbSection.classList.add('d-none');
            cameraSection.classList.remove('d-none');
        }
    });

    // USB Scanner - Refocus logic
    qrInput.addEventListener('blur', function(e) {
        setTimeout(() => {
            const activeElement = document.activeElement;
            if (!isProcessing && usbMode.checked && activeElement !== eventSelect && !activeElement.closest('.alert')) {
                qrInput.focus();
            }
        }, 100);
    });

    eventSelect.addEventListener('change', function() {
        if (usbMode.checked) {
            setTimeout(() => qrInput.focus(), 100);
        }
    });

    // USB Scanner - Enter key handler
    qrInput.addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            await processQRCode(qrInput.value.trim());
        }
    });

    // Camera Scanner
    startCamera.addEventListener('click', function() {
        startCameraScanner();
    });

    stopCamera.addEventListener('click', function() {
        stopCameraScanner();
    });

    function startCameraScanner() {
        const eventId = eventSelect.value;
        if (!eventId) {
            showFeedback('error', '@Localizer["PleaseSelectEvent"]');
            return;
        }

        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Try to get camera list first
        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length > 0) {
                // Use rear camera if available, otherwise use first camera
                const cameraId = cameras.length > 1 ? cameras[1].id : cameras[0].id;
                
                html5QrcodeScanner.start(
                    cameraId,
                    config,
                    async (decodedText) => {
                        if (!isProcessing) {
                            await processQRCode(decodedText);
                        }
                    },
                    (errorMessage) => {
                        // Ignore decode errors
                    }
                ).then(() => {
                    startCamera.classList.add('d-none');
                    stopCamera.classList.remove('d-none');
                }).catch((err) => {
                    showFeedback('error', `Kamera başlatılamadı: ${err}`);
                });
            } else {
                showFeedback('error', 'Kamera bulunamadı. USB tarayıcı kullanın.');
            }
        }).catch(err => {
            showFeedback('error', 'Kameraya erişim izni reddedildi veya kamera bulunamadı. Lütfen USB tarayıcıyı kullanın.');
            console.error('Camera error:', err);
        });
    }

    function stopCameraScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner = null;
                startCamera.classList.remove('d-none');
                stopCamera.classList.add('d-none');
            }).catch((err) => {
                console.error('Stop error:', err);
            });
        }
    }

    async function processQRCode(qrCode) {
        const eventId = eventSelect.value;

        if (!eventId) {
            showFeedback('error', '@Localizer["PleaseSelectEvent"]');
            return;
        }

        if (!qrCode) {
            return;
        }

        isProcessing = true;
        if (usbMode.checked) {
            qrInput.disabled = true;
        }

        try {
            const response = await fetch('/Scanner/CheckIn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    qrCode: qrCode,
                    eventId: eventId
                })
            });

            if (response.ok) {
                const result = await response.json();
                
                let statusText = '';
                if (result.status === 'AlreadyCheckedIn') {
                    statusText = '@Localizer["AlreadyCheckedIn"]';
                } else if (result.isNewCheckIn) {
                    statusText = '@Localizer["NewRegistration"]';
                } else {
                    statusText = '@Localizer["Updated"]';
                }

                showFeedback('success', `✓ ${result.userName} - ${statusText}`);
            } else {
                const error = await response.text();
                showFeedback('error', error || '@Localizer["CheckInFailed"]');
            }
        } catch (error) {
            showFeedback('error', '@Localizer["NetworkError"]');
            console.error('Check-in error:', error);
        } finally {
            if (usbMode.checked) {
                qrInput.value = '';
                qrInput.disabled = false;
                qrInput.focus();
            }
            isProcessing = false;
        }
    }

    function showFeedback(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
        
        feedbackArea.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="bi bi-${icon} me-2"></i>
                <strong>${message}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="setTimeout(() => { if (usbMode.checked) qrInput.focus(); }, 100)"></button>
            </div>
        `;

        if (type === 'success') {
            setTimeout(() => {
                const alert = feedbackArea.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }
    }
</script>
}
